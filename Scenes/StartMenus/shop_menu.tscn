[gd_scene load_steps=18 format=3 uid="uid://dwhs4hyoemtk"]

[ext_resource type="Texture2D" uid="uid://dnkxw0877x7hg" path="res://Graphics/shop_background.png" id="1_7bsho"]
[ext_resource type="Texture2D" uid="uid://o87nx6ar8uge" path="res://Graphics/UI/button_disabled.png" id="3_406a2"]
[ext_resource type="Texture2D" uid="uid://pwhnh7r5omus" path="res://Graphics/UI/button.png" id="3_u3cr1"]
[ext_resource type="Texture2D" uid="uid://b1oytv4glbt28" path="res://Graphics/UI/button_highlighted.png" id="4_dmbqw"]
[ext_resource type="Texture2D" uid="uid://cranl7y14bn3d" path="res://Graphics/UI/join.png" id="7_18qqm"]
[ext_resource type="Texture2D" uid="uid://n2ytkgauhjg3" path="res://Graphics/Item/emerald.png" id="7_gba3a"]
[ext_resource type="Texture2D" uid="uid://ciyarbruv7xfo" path="res://Graphics/UI/join_highlighted.png" id="8_fpc4r"]
[ext_resource type="FontFile" uid="uid://c0n8s8gx2dm18" path="res://Fonts/MinecraftAECN.ttf" id="8_jwn7w"]

[sub_resource type="GDScript" id="GDScript_ump2o"]
script/source = "extends Control;

@onready var description_label: Label = $CanvasLayer/DescriptionLabel;
@onready var value_label: Label = %ValueLabel;
@onready var buy_button: Button = $CanvasLayer/HBoxContainer2/BuyButton;
@onready var emerald_texture_sprite : TextureRect = $CanvasLayer/HBoxContainer2/CenterContainer/TextureRect;

var target_item_updrade_data : UpgradeItem = null;

func _ready() -> void:
	var iron_upgrade : UpgradeItem = UpgradeItem.new(\"iron_upgrade\");
	iron_upgrade.append(\"铁匠进阶\", preload(\"res://Graphics/Item/Iron/iron_pickaxe.png\"), \\
		50, \"这个升级能够让你制作铁制工具\\r顾客会要求你提供新的道具\");
	iron_upgrade.append(\"高阶铁匠技术\", preload(\"res://Graphics/Item/Iron/iron_chestplate.png\"), \\
		300, \"这个升级能够让你制作铁制装备\\r顾客会要求你提供新的道具\");
	# 铁匠工艺大师
	
	var gold_upgrade : UpgradeItem = UpgradeItem.new(\"gold_upgrade\");
	gold_upgrade.append(\"黄金工艺\", preload(\"res://Graphics/Item/Gold/gold_ingot.png\"), \\
		700, \"这个升级使你能够解锁黄金,并让你学会制作黄金装备\\r顾客会要求你提供新的道具\");
	gold_upgrade.append(\"璀璨黄金工法\", preload(\"res://Graphics/Item/Gold/golden_chestplate.png\"), \\
		2100, \"这个升级能够让你制作黄金装备\\r顾客会要求你提供新的道具\");
	
	var diamond_upgrade : UpgradeItem = UpgradeItem.new(\"diamond_upgrade\");
	diamond_upgrade.append(\"钻石矿工\", preload(\"res://Graphics/Item/Diamond/diamond.png\"), \\
		1800, \"这个升级能够让你采掘钻石\\r顾客会要求你提供新的道具\");
	diamond_upgrade.append(\"珠宝匠人\", preload(\"res://Graphics/Item/Diamond/diamond_sword.png\"), \\
		2600, \"这个升级能够让你制作钻石装备\\r顾客会要求你提供新的道具\");
	
	create_button(iron_upgrade, Vector2(110, 500));
	create_button(gold_upgrade, Vector2(280, 450));
	create_button(diamond_upgrade, Vector2(430, 480));
	
	var furnace_append : UpgradeItem = UpgradeItem.new(\"furnace_append\");
	furnace_append.append(\"熔炉\", preload(\"res://Graphics/Item/Block/furnace.png\"), \\
		150, \"购置一个新熔炉, 工作效率翻倍\");
	furnace_append.append(\"熔炉\", preload(\"res://Graphics/Item/Block/furnace.png\"), \\
		900, \"两个熔炉还不够, 再新增一个或许更好\");
	furnace_append.append(\"熔炉\", preload(\"res://Graphics/Item/Block/furnace.png\"), \\
		900, \"火力全开! 让你同时拥有4个熔炉\");
	
	var log_quick_filling : UpgradeItem = UpgradeItem.new(\"log_quick_filling\");
	log_quick_filling.append(\"快速装填\", preload(\"res://Graphics/Item/Block/log.png\"), \\
		75, \"调度你的伐木工,加速木材的填充速度\");
	
	var furnace_upgrade : UpgradeItem = UpgradeItem.new(\"furnace_upgrade\");
	furnace_upgrade.append(\"高炉\", preload(\"res://Graphics/Item/Block/blast_furnace.png\"), \\
		2000, \"将你的熔炉升级为高炉,将融化矿物的时间是缩减至原先的一半\");
	
	create_button(log_quick_filling, Vector2(875, 460));
	create_button(furnace_upgrade, Vector2(1000, 500));
	create_button(furnace_append, Vector2(1125, 475));
static var a = 10;

class UpgradeItem : 
	var item_list : Array[Dictionary] = [];
	var upgrade_count : int = 0;
	var item_id : String = \"\";
	var item_button : BaseButton = null;
	func _init(upgrade_item_id) -> void: 
		item_id = upgrade_item_id;
		if (!Global.upgrade_list.has(item_id)) : 
			return;
		upgrade_count = Global.upgrade_list[item_id];
	
	func append(display_text : String, display_texture : Texture2D, value : int, description : String) : 
		var data : Dictionary = {
			\"display_text\" : display_text,
			\"display_texture\" : display_texture,
			\"value\" : value,
			\"description\" : description
		};
		item_list.append(data);
	const SHOP_BUTTON = preload(\"res://Scenes/StartMenus/shop_button.tscn\");
	
	func create_button(pos : Vector2) -> BaseButton : 
		if (item_button != null) : return;
		var button : BaseButton = SHOP_BUTTON.instantiate();
		item_button = button;
		button.global_position = pos;
		if ( upgrade_count >= item_list.size()  ) : 
			upgrade_count = min(upgrade_count, item_list.size()-1);
			button.disabled = true;
		button.text = item_list[upgrade_count][\"display_text\"];
		button.texture = item_list[upgrade_count][\"display_texture\"];
		
		button.item_upgrade_data = self;
		return button;
	
	func update_button() : 
		if (item_button == null) : return;
		if (upgrade_count >= item_list.size()) : 
			item_button.disabled = true;
			return;
		item_button.text = item_list[upgrade_count][\"display_text\"];
		item_button.texture = item_list[upgrade_count][\"display_texture\"];

func create_button(upgrade_item_data : UpgradeItem , pos : Vector2) : 
	var button : BaseButton = upgrade_item_data.create_button(pos);
	if (button) : 
		button.signal_button_pressed.connect(set_target_upgrade_item);
		self.add_child(button);

func set_target_upgrade_item(item : UpgradeItem) : 
	if (item == null || item.upgrade_count >= item.item_list.size()) : 
		description_label.text = \"\";
		value_label.text = \"\";
		buy_button.disabled = true;
		item.item_button.disabled = true;
		emerald_texture_sprite.hide();
		return;
	AudioManager.play_suond(CLICK_SOUND);
	description_label.text = item.item_list[item.upgrade_count][\"description\"];
	value_label.text = str(item.item_list[item.upgrade_count][\"value\"]);
	buy_button.disabled = (Global.emerald_count - item.item_list[item.upgrade_count][\"value\"]) < 0;
	emerald_texture_sprite.show();
	target_item_updrade_data = item;

func _on_buy_button_pressed() -> void : 
	AudioManager.play_suond(CLICK_SOUND);
	if (target_item_updrade_data == null) : return;
	if (target_item_updrade_data.upgrade_count < target_item_updrade_data.item_list.size()) : 
		Global.emerald_count -= target_item_updrade_data.item_list[target_item_updrade_data.upgrade_count][\"value\"];
		target_item_updrade_data.upgrade_count += 1;
		Global.set_upgrade(target_item_updrade_data.item_id, target_item_updrade_data.upgrade_count);
	else : 
		target_item_updrade_data.item_button.disabled = true;
		target_item_updrade_data = null;
	set_target_upgrade_item(target_item_updrade_data);
	target_item_updrade_data.update_button();

const CLICK_SOUND = preload(\"res://Audio/Sound/Click.ogg\");
func _on_exit_button_pressed() -> void:
	AudioManager.play_suond(CLICK_SOUND);
	SceneManager.change_scene_form_file(\"res://Scenes/StartMenus/main_menu.tscn\");
"

[sub_resource type="GDScript" id="GDScript_2d2tk"]
script/source = "extends CanvasLayer;
@onready var emerald_count_label: Label = $HBoxContainer/EmeraldCountLabel;

var emerald_count : float = 0.0;
var label_emerald_count : float = 0.0 : 
	set(value) : 
		label_emerald_count = value;
		emerald_count_label.text = str(round(value));

func _process(delta: float) -> void:
	if (emerald_count != Global.emerald_count) : 
		var tween : Tween = get_tree().create_tween();
		emerald_count = Global.emerald_count;
		tween.tween_property(self, \"label_emerald_count\", emerald_count, 1.0).set_ease(Tween.EASE_OUT).set_trans(Tween.TRANS_SINE);
"

[sub_resource type="LabelSettings" id="LabelSettings_5e4mp"]
font = ExtResource("8_jwn7w")
font_size = 24
shadow_size = 0
shadow_color = Color(0, 0, 0, 1)
shadow_offset = Vector2(2, 2)

[sub_resource type="LabelSettings" id="LabelSettings_hf1an"]
font = ExtResource("8_jwn7w")
font_size = 32
shadow_size = 0
shadow_color = Color(0, 0, 0, 1)
shadow_offset = Vector2(2, 2)

[sub_resource type="LabelSettings" id="LabelSettings_l5i6a"]
font = ExtResource("8_jwn7w")
shadow_size = 0
shadow_color = Color(0, 0, 0, 1)
shadow_offset = Vector2(2, 2)

[sub_resource type="StyleBoxEmpty" id="StyleBoxEmpty_xvaml"]

[sub_resource type="StyleBoxTexture" id="StyleBoxTexture_nenss"]
texture = ExtResource("3_406a2")
texture_margin_left = 5.0
texture_margin_top = 5.0
texture_margin_right = 5.0
texture_margin_bottom = 5.0
axis_stretch_horizontal = 1
axis_stretch_vertical = 2

[sub_resource type="StyleBoxTexture" id="StyleBoxTexture_sik3p"]
texture = ExtResource("4_dmbqw")
texture_margin_left = 5.0
texture_margin_top = 5.0
texture_margin_right = 5.0
texture_margin_bottom = 5.0
axis_stretch_horizontal = 1
axis_stretch_vertical = 2

[sub_resource type="StyleBoxTexture" id="StyleBoxTexture_4fv8l"]
texture = ExtResource("3_u3cr1")
texture_margin_left = 5.0
texture_margin_top = 5.0
texture_margin_right = 5.0
texture_margin_bottom = 5.0
axis_stretch_horizontal = 1
axis_stretch_vertical = 2

[node name="ShopMenu" type="Control"]
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("GDScript_ump2o")

[node name="ShopBackground" type="TextureRect" parent="."]
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = 1.0
offset_right = 1.0
grow_horizontal = 2
grow_vertical = 2
texture = ExtResource("1_7bsho")
expand_mode = 1

[node name="CanvasLayer" type="CanvasLayer" parent="."]
script = SubResource("GDScript_2d2tk")

[node name="HBoxContainer" type="HBoxContainer" parent="CanvasLayer"]
anchors_preset = 1
anchor_left = 1.0
anchor_right = 1.0
offset_left = -96.0
offset_top = 2.0
offset_right = -10.0
offset_bottom = 66.0
grow_horizontal = 0

[node name="EmeraldTexture" type="TextureRect" parent="CanvasLayer/HBoxContainer"]
custom_minimum_size = Vector2(64, 64)
layout_mode = 2
texture = ExtResource("7_gba3a")
expand_mode = 3

[node name="EmeraldCountLabel" type="Label" parent="CanvasLayer/HBoxContainer"]
layout_mode = 2
size_flags_horizontal = 8
text = "0"
label_settings = SubResource("LabelSettings_5e4mp")

[node name="DescriptionLabel" type="Label" parent="CanvasLayer"]
anchors_preset = 12
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = 127.0
offset_top = -109.0
offset_right = -562.0
grow_horizontal = 2
grow_vertical = 0
label_settings = SubResource("LabelSettings_hf1an")
autowrap_mode = 1

[node name="HBoxContainer2" type="HBoxContainer" parent="CanvasLayer"]
offset_left = 329.0
offset_top = 688.0
offset_right = 796.0
offset_bottom = 714.0
scale = Vector2(2, 2)
size_flags_horizontal = 8
theme_override_constants/separation = 0
alignment = 2

[node name="ValueLabel" type="Label" parent="CanvasLayer/HBoxContainer2"]
unique_name_in_owner = true
layout_mode = 2
size_flags_horizontal = 4
size_flags_vertical = 1
label_settings = SubResource("LabelSettings_l5i6a")
horizontal_alignment = 1
vertical_alignment = 1

[node name="CenterContainer" type="CenterContainer" parent="CanvasLayer/HBoxContainer2"]
layout_mode = 2
size_flags_horizontal = 4
size_flags_vertical = 4

[node name="TextureRect" type="TextureRect" parent="CanvasLayer/HBoxContainer2/CenterContainer"]
visible = false
custom_minimum_size = Vector2(25, 25)
layout_mode = 2
texture = ExtResource("7_gba3a")

[node name="BuyButton" type="Button" parent="CanvasLayer/HBoxContainer2"]
custom_minimum_size = Vector2(150, 0)
layout_mode = 2
size_flags_horizontal = 8
theme_override_colors/font_color = Color(1, 1, 1, 1)
theme_override_fonts/font = ExtResource("8_jwn7w")
theme_override_font_sizes/font_size = 16
theme_override_styles/focus = SubResource("StyleBoxEmpty_xvaml")
theme_override_styles/disabled = SubResource("StyleBoxTexture_nenss")
theme_override_styles/hover = SubResource("StyleBoxTexture_sik3p")
theme_override_styles/pressed = SubResource("StyleBoxTexture_nenss")
theme_override_styles/normal = SubResource("StyleBoxTexture_4fv8l")
text = "购买"

[node name="ExitButton" type="TextureButton" parent="CanvasLayer"]
offset_left = 18.0
offset_top = 15.0
offset_right = 75.0
offset_bottom = 72.0
texture_normal = ExtResource("7_18qqm")
texture_pressed = ExtResource("8_fpc4r")
texture_hover = ExtResource("8_fpc4r")
stretch_mode = 6
flip_h = true

[connection signal="pressed" from="CanvasLayer/HBoxContainer2/BuyButton" to="." method="_on_buy_button_pressed"]
[connection signal="pressed" from="CanvasLayer/ExitButton" to="." method="_on_exit_button_pressed"]
